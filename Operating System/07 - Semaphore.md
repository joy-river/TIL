### Semaphore(세마포어)

---

- 운영체제가 제공하는 Synchronization primitives 중 마지막 하나이다.

  > Mutex, CV, Semaphore 총 세 가지가 존재한다.

- 일종의 Combination of Mutex and CV, 뮤텍스나 CV를 일반화 시킨 것 이다.

  - 뮤텍스나 CV를 세마포어로 구현할 수 있다.

  - 정수 값을 가지는 object(객체)로 사용한다.

- 세마포어는 sem_init()을 통해 선언된다.

  - sem_init()은 세 개의 매개변수를 가진다.

    - 첫 매개변수는 세마포어의 포인터이다.

    - 둘째 매개변수는 세마포어의 공유 여부를 결정한다.

      > 0일 경우 스레드간 공유가 되며, 그 이외에는 프로세스간 공유된다.

    - 셋째 매개변수는 세마포어의 초기 값이 된다.

- 세마포어는 두 개의 함수를 통해 동작한다.

  > sem_wait()

  - 세마포어의 값을 1 줄인다.

  - 만약 그 값이 음수가 되면, 호출 스레드는 대기한다.

  - 따라서 음수 값 만큼의 스레드가 대기(실행을 정지하고, post를 기다린다.)하게 된다.

  > sem_post()

  - wait와 반대로 세마포어의 값을 1 올린다.

  - 만약 한개 이상의 스레드가 대기 중이면, 그 중 하나를 wake한다.

- 세마포어의 값을 1로 만들면 = Mutex로 사용가능하다.

  - 한 스레드가 1 -> 0 으로 만들면, 다른 스레드는 wait하게 된다.

  - 상호 배제를 구현할 수 있다!

- 세마포어의 값을 0으로 만들면 = CV로 사용 가능하다.

  - 부모 스레드가 wait를 호출해 대기 상태가 되고

  - 자식 스레드는 작업을 끝낸 후 post로 부모를 깨워준다.

### Producer - Consumer model with Semaphore

---

- 이전에 살펴본 동시성 문제 중 하나인 생산자-소비자 문제를 되짚어보자.

  - 우리에게 여러 데이터가 들어갈 수 있는 버퍼가 있다.

  - Put()은 버퍼가 빌 때 까지 대기하다가 버퍼에 데이터를 넣는다.

  - Get()은 버퍼가 꽉 찰 때 까지 대기하다가 버퍼에서 데이터를 가져온다.

* 첫 번째 시도, 두 개의 세마포어를 사용하여 이 문제를 접근해보자.

  > Empty와 Full을 선언한다.

  - empty = 버퍼의 최대 크기 MAX 값으로 초기화한다.

  - full = 0으로 초기화 한다.

    - 생산자는 wait(&empty)로 버퍼에 빈 공간이 있는지 체크하고, post(&full)로 버퍼에 데이터를 넣었음을 표시한다.

    - 소비자는 wait(&full)로 버퍼가 가득 차 있는지 체크하고, post(&empty)로 버퍼에 빈 공간을 만들었음을 표시한다.

  - 보기엔 좋아보이나, 만약 MAX > 1 일 경우 경쟁 상태가 발생할 수 있다.

    - 버퍼에 있던 데이터가 덮어 씌워질 가능성이 있다.

    - 즉, 상호 배제를 구현하지 못한다.

* 두 번째 시도, 뮤텍스의 역할을 하는 세마포어를 추가하자.

  - 뮤텍스로 생산자와 소비자를 감싸서 구현해보자.

    - 뮤텍스 내부에서 뮤텍스 락을 얻은 상태로 sleep해버리면 어떡하지?

    - 버퍼가 차길 기다리는 소비자가 있는데, 생산자가 락을 얻질 못한다.

    > Deadlock이 발생한다!

  - 오히려 뮤텍스가 생산자와 소비자에게 감싸여지게 구현하자.

    - 만약 소비자가 put()을 기다리며 잠든 상태더라도, 뮤텍스 락은 획득하지 않았으므로, put()으로 버퍼에 접근이 가능하다.

### DIning Philosophers

---

- 원형 테이블에 철학자 5명이 식사를 하려고 앉아 있다.

- 각 철학자 사이에는 포크 한 개가 총 5개 놓여있다.

- 각 철학자는 딱 두개의 행동만 취할 수 있다.

  - think = 포크가 필요 없이 사색에 잠긴다.

  - eat = 양 손에 포크를 가지고 있을 때, 식사를 한다.

- 철학자의 숫자에 비해, 포크의 개수가 적어 포크를 둘러싼 경쟁이 발생한다.

  - 어떻게 해결하면 좋을까? 세 가지 조건을 두자.

    1. 모든 철학자가 식사를 못하는 경우(데드락)는 없다.

    2. 어떤 철학자도 굶주리진 않아야한다.

    3. 동시성을 가능한 한 높이자.

* 세마포어를 사용해서 이 문제를 해결하자.

  - 각 포크가 세마포어 하나가 된다.

    - 각 철학자는 자기 왼쪽의 포크를 집고, 오른쪽 포크가 사용가능할 때까지 기다린다.

    - 모든 철학자가 왼쪽 포크를 잡아버리면?

    > 데드락 발생!

  - 모든 철학자 중 한 명만 다른 행동 방식을 가지면 된다.

    - 이 철학자는 오른쪽 포크를 먼저 잡고, 왼쪽 포크를 기다린다.

    - 모든 철학자가 순번에 맞게 음식을 먹을 수 있다.
